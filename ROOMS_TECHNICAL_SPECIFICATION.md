# ТЕХНИЧЕСКОЕ ЗАДАНИЕ: Система комнат для Energy of Money

## 1. ОБЩЕЕ ОПИСАНИЕ

### 1.1 Назначение
Система комнат предназначена для создания игровых сессий, где игроки могут присоединяться к игре "Energy of Money" и играть в режиме реального времени.

### 1.2 Основные функции
- Создание игровых комнат
- Присоединение игроков к комнатам
- Управление жизненным циклом комнат
- Персистентное хранение данных
- Мониторинг и статистика

## 2. АРХИТЕКТУРА СИСТЕМЫ

### 2.1 Компоненты
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Socket.IO     │    │   MongoDB       │
│   (Next.js)     │◄──►│   Server        │◄──►│   Database      │
│                 │    │   (Node.js)     │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 Технологический стек
- **Frontend**: Next.js, React, TypeScript
- **Backend**: Node.js, Express, Socket.IO
- **Database**: MongoDB с Mongoose ODM
- **Deployment**: Render.com
- **Real-time**: WebSocket (Socket.IO)

## 3. МОДЕЛЬ ДАННЫХ

### 3.1 Модель Room (Комната)
```javascript
{
  id: String,                    // Уникальный ID комнаты
  name: String,                  // Название комнаты
  creatorId: String,             // ID создателя (socket.id)
  creatorUsername: String,       // Имя создателя
  creatorProfession: String,     // Профессия создателя
  creatorDream: String,          // Мечта создателя
  assignProfessionToAll: Boolean, // Назначить профессию всем
  availableProfessions: [String], // Доступные профессии в комнате
  professionSelectionMode: String, // "random" | "choice" | "assigned"
  maxPlayers: Number,            // Максимум игроков (2-10)
  password: String,              // Пароль комнаты (опционально)
  timing: Number,                // Время хода в секундах (60-300)
  createdAt: Date,               // Дата создания
  gameDurationSec: Number,       // Длительность игры в секундах
  gameEndAt: Date,               // Время окончания игры
  deleteAfterAt: Date,           // Время удаления комнаты
  players: [Player],             // Массив игроков
  started: Boolean,              // Игра началась
  order: [String],               // Порядок ходов
  currentIndex: Number,          // Текущий игрок
  turnEndAt: Date,               // Время окончания хода
  lastActivity: Date,            // Последняя активность
  isActive: Boolean              // Комната активна
}
```

### 3.2 Модель Player (Игрок)
```javascript
{
  id: String,                    // Уникальный ID игрока
  name: String,                  // Имя игрока
  email: String,                 // Email игрока
  socketId: String,              // Socket ID для связи
  isReady: Boolean,              // Готов к игре
  profession: String,            // Профессия игрока
  dream: String,                 // Мечта игрока
  selectedProfession: String,    // Выбранная профессия (если есть выбор)
  professionConfirmed: Boolean,  // Профессия подтверждена
  joinedAt: Date,                // Время присоединения
  money: Number,                 // Деньги игрока
  position: Number,              // Позиция на поле
  cards: [Card],                 // Карты игрока
  isActive: Boolean              // Игрок активен
}
```

### 3.3 Модель HallOfFame (Зал славы)
```javascript
{
  username: String,              // Имя игрока
  games: Number,                 // Количество игр
  wins: Number,                  // Количество побед
  points: Number,                // Очки
  lastPlayed: Date,              // Последняя игра
  totalPlayTime: Number,         // Общее время игры (сек)
  averageGameTime: Number,       // Среднее время игры (сек)
  winRate: Number,               // Процент побед
  createdAt: Date,               // Дата регистрации
  updatedAt: Date                // Дата обновления
}
```

## 4. API СПЕЦИФИКАЦИЯ

### 4.1 REST API Endpoints

#### GET /
**Описание**: Статус сервера
**Ответ**:
```json
{
  "ok": true,
  "name": "energy888-socket-server",
  "message": "Energy888 Socket Server with MongoDB is running",
  "environment": "production",
  "port": 4000,
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

#### GET /health
**Описание**: Проверка здоровья сервера
**Ответ**:
```json
{
  "ok": true,
  "status": "healthy",
  "timestamp": "2024-01-01T12:00:00.000Z",
  "uptime": 3600
}
```

#### GET /stats
**Описание**: Статистика сервера
**Ответ**:
```json
{
  "ok": true,
  "totalRooms": 5,
  "totalPlayers": 12,
  "isConnected": true,
  "uptime": 3600,
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

#### GET /hall-of-fame?limit=10&sortBy=points
**Описание**: Топ игроков
**Параметры**:
- `limit` (number): Количество игроков (по умолчанию 10)
- `sortBy` (string): Поле сортировки (points, wins, winRate)

**Ответ**:
```json
{
  "ok": true,
  "players": [
    {
      "username": "player1",
      "games": 10,
      "wins": 7,
      "points": 1500,
      "winRate": 70
    }
  ],
  "limit": 10,
  "sortBy": "points"
}
```

### 4.2 Socket.IO Events

#### Клиент → Сервер

##### get-rooms
**Описание**: Получить список всех комнат
**Данные**: Нет
**Ответ**: `rooms-list`

##### create-room
**Описание**: Создать новую комнату
**Данные**:
```javascript
{
  name: String,                  // Название комнаты
  maxPlayers: Number,            // Максимум игроков (2-10)
  timing: Number,                // Время хода в минутах
  playerName: String,            // Имя создателя
  playerEmail: String,           // Email создателя
  password: String,              // Пароль (опционально)
  professionSelectionMode: String, // "random" | "choice" | "assigned"
  availableProfessions: [String], // Доступные профессии
  assignProfessionToAll: Boolean // Назначить профессию всем
}
```
**Ответ**: `room-created`

##### join-room
**Описание**: Присоединиться к комнате
**Данные**:
```javascript
{
  roomId: String,                // ID комнаты
  playerName: String,            // Имя игрока
  playerEmail: String,           // Email игрока
  password: String               // Пароль (если требуется)
}
```
**Ответ**: `room-joined` или `error`

##### rooms-updated
**Описание**: Запросить обновление списка комнат
**Данные**: Нет
**Ответ**: `rooms-list`

##### select-profession
**Описание**: Выбрать профессию в комнате
**Данные**:
```javascript
{
  roomId: String,                // ID комнаты
  profession: String,            // Выбранная профессия
  playerId: String               // ID игрока
}
```
**Ответ**: `profession-selected` или `error`

##### confirm-profession
**Описание**: Подтвердить выбор профессии
**Данные**:
```javascript
{
  roomId: String,                // ID комнаты
  playerId: String,              // ID игрока
  confirmed: Boolean             // Подтверждение
}
```
**Ответ**: `profession-confirmed` или `error`

##### get-available-professions
**Описание**: Получить доступные профессии в комнате
**Данные**:
```javascript
{
  roomId: String                 // ID комнаты
}
```
**Ответ**: `available-professions`

#### Сервер → Клиент

##### rooms-list
**Описание**: Список комнат
**Данные**:
```javascript
[
  {
    id: String,
    name: String,
    maxPlayers: Number,
    players: Number,              // Текущее количество игроков
    status: String,               // "waiting" | "playing"
    timing: Number                // Время хода в секундах
  }
]
```

##### room-created
**Описание**: Комната создана
**Данные**:
```javascript
{
  id: String,
  name: String,
  maxPlayers: Number,
  players: Number,
  timing: Number,
  status: String
}
```

##### room-joined
**Описание**: Успешно присоединились к комнате
**Данные**:
```javascript
{
  id: String,
  name: String,
  maxPlayers: Number,
  players: Number,
  timing: Number,
  status: String,
  playersList: [Player]          // Список всех игроков
}
```

##### room-updated
**Описание**: Комната обновлена
**Данные**: Аналогично `room-joined`

##### rooms-updated
**Описание**: Список комнат обновлен
**Данные**: Нет
**Действие**: Клиент должен запросить `get-rooms`

##### available-professions
**Описание**: Доступные профессии в комнате
**Данные**:
```javascript
{
  roomId: String,
  professions: [String],         // Список доступных профессий
  selectionMode: String,         // Режим выбора профессий
  selectedProfessions: [String]  // Уже выбранные профессии
}
```

##### profession-selected
**Описание**: Профессия выбрана
**Данные**:
```javascript
{
  roomId: String,
  playerId: String,
  profession: String,
  success: Boolean
}
```

##### profession-confirmed
**Описание**: Профессия подтверждена
**Данные**:
```javascript
{
  roomId: String,
  playerId: String,
  profession: String,
  confirmed: Boolean
}
```

##### profession-selection-updated
**Описание**: Обновление выбора профессий в комнате
**Данные**:
```javascript
{
  roomId: String,
  players: [Player],             // Обновленный список игроков
  availableProfessions: [String], // Оставшиеся профессии
  allProfessionsSelected: Boolean // Все профессии выбраны
}
```

##### error
**Описание**: Ошибка
**Данные**:
```javascript
{
  message: String,               // Сообщение об ошибке
  code: String                   // Код ошибки (опционально)
}
```

## 5. БИЗНЕС-ЛОГИКА

### 5.1 Создание комнаты
1. Валидация входных данных (maxPlayers: 2-10)
2. Генерация уникального ID комнаты
3. Настройка режима выбора профессий
4. Создание записи в MongoDB
5. Добавление в кэш для быстрого доступа
6. Уведомление всех клиентов об обновлении
7. Автоматическое присоединение создателя к комнате

### 5.2 Присоединение к комнате
1. Проверка существования комнаты
2. Проверка наличия свободных мест
3. Проверка пароля (если требуется)
4. Добавление игрока в комнату
5. Обновление данных в MongoDB
6. Уведомление всех игроков в комнате

### 5.3 Управление жизненным циклом комнат
1. **Создание**: Комната создается и остается активной
2. **Активность**: Комната активна пока есть игроки
3. **Пустота**: Если все игроки покинули комнату, планируется удаление через 1 час
4. **Удаление**: Комната удаляется через 24 часа если пустая
5. **Очистка**: Автоматическая очистка неактивных комнат каждые 30 минут

### 5.4 Выбор профессий
1. **Режим "random"**: Профессии назначаются случайно при присоединении
2. **Режим "choice"**: Игроки выбирают профессии из доступного списка
3. **Режим "assigned"**: Все игроки получают профессию создателя
4. Валидация выбора профессии (уникальность, доступность)
5. Обновление статуса выбора профессии
6. Уведомление всех игроков об изменениях
7. Проверка готовности к началу игры

### 5.5 Обработка отключений
1. При отключении игрока он удаляется из комнаты
2. Если комната становится пустой, планируется удаление через 1 час
3. Если игрок переподключается в течение 1 часа, комната остается активной
4. Обновляется статистика активности комнаты
5. При отключении во время выбора профессии - профессия освобождается

## 6. ТРЕБОВАНИЯ К ПРОИЗВОДИТЕЛЬНОСТИ

### 6.1 Нагрузка
- **Одновременные подключения**: до 1000
- **Комнат одновременно**: до 500
- **Игроков в комнате**: 2-10
- **Время отклика API**: < 200ms
- **Время отклика Socket.IO**: < 100ms

### 6.2 Масштабируемость
- Горизонтальное масштабирование через MongoDB
- Кэширование часто используемых данных
- Асинхронная обработка операций
- Пакетная обработка обновлений

## 7. БЕЗОПАСНОСТЬ

### 7.1 Аутентификация
- Валидация всех входящих данных
- Проверка прав доступа к комнатам
- Защита от SQL-инъекций через Mongoose
- Ограничение частоты запросов

### 7.2 CORS
- Настройка разрешенных доменов
- Поддержка credentials
- Обработка preflight запросов

## 8. МОНИТОРИНГ И ЛОГИРОВАНИЕ

### 8.1 Логирование
- Все операции с комнатами
- Ошибки и исключения
- Производительность запросов
- Подключения и отключения игроков

### 8.2 Метрики
- Количество активных комнат
- Количество подключенных игроков
- Время отклика API
- Использование памяти и CPU
- Статистика ошибок

## 9. РАЗВЕРТЫВАНИЕ

### 9.1 Требования к окружению
- Node.js >= 18.0.0
- MongoDB >= 4.4
- 512MB RAM (минимум)
- 1GB дискового пространства

### 9.2 Переменные окружения
```env
NODE_ENV=production
PORT=4000
MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/db
FRONT_ORIGIN=*
BOT_TOKEN=your_telegram_bot_token
```

### 9.3 Docker (опционально)
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 4000
CMD ["node", "production-server.js"]
```

## 10. ТЕСТИРОВАНИЕ

### 10.1 Unit тесты
- Тестирование моделей данных
- Тестирование бизнес-логики
- Тестирование API endpoints

### 10.2 Integration тесты
- Тестирование Socket.IO событий
- Тестирование работы с MongoDB
- Тестирование полного цикла создания комнаты

### 10.3 Load тесты
- Тестирование под нагрузкой
- Тестирование одновременных подключений
- Тестирование производительности

## 11. ДОКУМЕНТАЦИЯ

### 11.1 API документация
- Swagger/OpenAPI спецификация
- Примеры запросов и ответов
- Коды ошибок и их описания

### 11.2 Руководство разработчика
- Инструкции по настройке
- Архитектурные решения
- Соглашения по коду

## 12. ПЛАН РЕАЛИЗАЦИИ

### 12.1 Этап 1: Базовая функциональность (1-2 дня)
- [x] Модели данных
- [x] Базовые API endpoints
- [x] Socket.IO события
- [x] Создание и присоединение к комнатам

### 12.2 Этап 2: Персистентность (1 день)
- [x] Интеграция с MongoDB
- [x] Восстановление комнат при запуске
- [x] Кэширование для производительности

### 12.3 Этап 3: Мониторинг и оптимизация (1 день)
- [x] Статистика и мониторинг
- [x] Логирование
- [x] Обработка ошибок

### 12.4 Этап 4: Система выбора профессий (1-2 дня)
- [ ] Реализация режимов выбора профессий
- [ ] Socket.IO события для выбора профессий
- [ ] Валидация и проверка уникальности
- [ ] Обновление UI для выбора профессий
- [ ] Тестирование всех режимов

### 12.5 Этап 5: Развертывание (1 день)
- [x] Конфигурация для Render.com
- [x] Настройка MongoDB Atlas
- [x] Деплой и тестирование

## 13. КРИТЕРИИ ПРИЕМКИ

### 13.1 Функциональные требования
- ✅ Создание комнат работает стабильно (2-10 игроков)
- ✅ Присоединение к комнатам работает
- ✅ Комнаты сохраняются при перезапуске
- ✅ Данные не теряются при отключении
- ✅ Мониторинг и статистика доступны
- [ ] Система выбора профессий работает
- [ ] Все режимы выбора профессий функционируют
- [ ] Валидация выбора профессий работает корректно

### 13.2 Нефункциональные требования
- ✅ Время отклика < 200ms
- ✅ Поддержка до 1000 одновременных подключений
- ✅ Автоматическое восстановление после сбоев
- ✅ Подробное логирование всех операций

## 14. ИЗВЕСТНЫЕ ПРОБЛЕМЫ И ОГРАНИЧЕНИЯ

### 14.1 Текущие проблемы
- ❌ Комнаты удаляются через 5 часов (исправлено)
- ❌ Нет персистентности данных (исправлено)
- ❌ Нет мониторинга (исправлено)

### 14.2 Ограничения
- Максимум 10 игроков в комнате (минимум 2)
- Комнаты удаляются через 24 часа если пустые
- Требуется MongoDB для работы
- Профессии должны быть уникальными в комнате (режим "choice")
- Максимум 10 доступных профессий для выбора

## 15. БУДУЩИЕ УЛУЧШЕНИЯ

### 15.1 Краткосрочные (1-2 недели)
- ✅ Добавление паролей к комнатам
- ✅ Система выбора профессий в комнате
- Система рейтингов игроков
- Уведомления о событиях в комнате
- Визуальный интерфейс выбора профессий
- Таймер для выбора профессий

### 15.2 Долгосрочные (1-2 месяца)
- Система турниров
- Интеграция с социальными сетями
- Мобильное приложение

---

**Версия документа**: 1.0  
**Дата создания**: 2024-01-01  
**Автор**: AI Assistant  
**Статус**: В разработке
