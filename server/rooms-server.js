import express from 'express';
import http from 'http';
import { Server } from 'socket.io';
import cors from 'cors';
import dotenv from 'dotenv';
import { RoomController, PROFESSIONS, ROOM_CONFIGS } from '../modules/rooms/index.js';
import DatabaseService from '../modules/rooms/services/DatabaseService.js';

dotenv.config();

const app = express();
const FRONT_ORIGIN = process.env.FRONT_ORIGIN || '*';

// CORS configuration
const corsOptions = {
  origin: function (origin, callback) {
    if (!origin) return callback(null, true);
    
    const allowedOrigins = [
      'https://money8888-production.up.railway.app',
      'https://money8888-production.up.railway.app',
      'https://money8888-production.up.railway.app',
      'http://localhost:3000',
      'http://localhost:3001'
    ];
    
    if (FRONT_ORIGIN === '*' || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Bot-Token']
};

app.use(cors(corsOptions));
app.use(express.json());

// Handle preflight requests
app.options('*', (req, res) => {
  res.header('Access-Control-Allow-Origin', req.headers.origin || '*');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Bot-Token');
  res.header('Access-Control-Allow-Credentials', 'true');
  res.sendStatus(200);
});

const server = http.createServer(app);
const io = new Server(server, {
  cors: {
    origin: [
      'https://money8888-production.up.railway.app',
      'https://money8888-production.up.railway.app',
      'https://money8888-production.up.railway.app',
      'http://localhost:3000',
      'http://localhost:3001'
    ],
    methods: ['GET', 'POST'],
    credentials: true
  } 
});

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ð° ÐºÐ¾Ð¼Ð½Ð°Ñ‚
const roomController = new RoomController();
let dbInitialized = false;

// ===== REST API ENDPOINTS =====

app.get('/', (_req, res) => res.json({ 
  ok: true, 
  name: 'energy888-rooms-server',
  message: 'Energy of Money Rooms Server with MongoDB',
  environment: process.env.NODE_ENV || 'development',
  port: process.env.PORT || 4000,
  timestamp: new Date().toISOString(),
  features: ['rooms', 'professions', 'mongodb', 'socket.io']
}));

app.get('/health', (_req, res) => {
  res.json({ 
    ok: true, 
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    database: dbInitialized ? 'connected' : 'disconnected'
  });
});

app.get('/stats', async (_req, res) => {
  try {
    const stats = await roomController.getServerStats();
    res.json({
      ok: true,
      ...stats
    });
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸:', error);
    res.status(500).json({ ok: false, error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸' });
  }
});

app.get('/professions', (_req, res) => {
  res.json({
    ok: true,
    professions: PROFESSIONS,
    configs: ROOM_CONFIGS
  });
});

app.get('/rooms', async (_req, res) => {
  try {
    const rooms = await roomController.getAllRooms();
    const roomsData = roomController.getRoomsListData(rooms);
    res.json({
      ok: true,
      rooms: roomsData,
      total: roomsData.length
    });
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð½Ð°Ñ‚:', error);
    res.status(500).json({ ok: false, error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð½Ð°Ñ‚' });
  }
});

// ===== SOCKET.IO HANDLERS =====

io.on('connection', async (socket) => {
  console.log('ðŸ”Œ ÐÐ¾Ð²Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ:', socket.id);

  // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸
  if (!dbInitialized) {
    try {
      await DatabaseService.connect();
      dbInitialized = true;
      console.log('âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°');
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð‘Ð”:', error);
    }
  }

  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚
  socket.on('get-rooms', async () => {
    try {
      console.log('ðŸ“‹ Ð—Ð°Ð¿Ñ€Ð¾Ñ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð½Ð°Ñ‚ Ð¾Ñ‚:', socket.id);
      const rooms = await roomController.getAllRooms();
      const roomsData = roomController.getRoomsListData(rooms);
      socket.emit('rooms-list', roomsData);
      console.log('ðŸ“‹ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ ÐºÐ¾Ð¼Ð½Ð°Ñ‚:', roomsData.length);
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð½Ð°Ñ‚:', error);
      socket.emit('error', { message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð½Ð°Ñ‚' });
    }
  });

  // Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ
  socket.on('create-room', async (data) => {
    try {
      console.log('ðŸ  Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹ Ð¾Ñ‚:', socket.id, data);
      
      const result = await roomController.createRoom(data);
      if (result.success && result.room) {
        const roomData = roomController.getRoomClientData(result.room);
        socket.emit('room-created', roomData);
        io.emit('rooms-updated');
        console.log('âœ… ÐšÐ¾Ð¼Ð½Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð°:', result.room.id);
      } else {
        socket.emit('error', { message: result.error || 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹' });
      }
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹:', error);
      socket.emit('error', { message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹' });
    }
  });

  // ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½Ð¸Ñ‚ÑŒÑÑ Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ
  socket.on('join-room', async (data) => {
    try {
      console.log('ðŸšª ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ Ð¾Ñ‚:', socket.id, data);
      
      const result = await roomController.joinRoom(data, socket.id);
      if (result.success && result.room) {
        socket.join(result.room.id);
        const roomData = roomController.getRoomClientData(result.room);
        socket.emit('room-joined', roomData);
        io.to(result.room.id).emit('room-updated', roomData);
        io.emit('rooms-updated');
        console.log('âœ… Ð˜Ð³Ñ€Ð¾Ðº Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½Ð¸Ð»ÑÑ Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ:', data.roomId);
      } else {
        socket.emit('error', { message: result.error || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ' });
      }
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ:', error);
      socket.emit('error', { message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ' });
    }
  });

  // Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸ÑŽ
  socket.on('select-profession', async (data) => {
    try {
      console.log('ðŸŽ­ Ð’Ñ‹Ð±Ð¾Ñ€ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¸ Ð¾Ñ‚:', socket.id, data);
      
      const result = await roomController.selectProfession(data);
      if (result.success) {
        const room = await roomController.getRoom(data.roomId);
        if (room) {
          const roomData = roomController.getRoomClientData(room);
          socket.emit('profession-selected', {
            roomId: data.roomId,
            playerId: data.playerId,
            profession: data.profession,
            success: true
          });
          io.to(data.roomId).emit('profession-selection-updated', {
            roomId: data.roomId,
            players: Array.from(room.players.values()),
            availableProfessions: room.availableProfessions.filter(prof => 
              !Array.from(room.players.values()).some(p => p.profession === prof)
            ),
            allProfessionsSelected: Array.from(room.players.values()).every(p => p.profession)
          });
        }
      } else {
        socket.emit('error', { message: result.error || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¸' });
      }
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¸:', error);
      socket.emit('error', { message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¸' });
    }
  });

  // ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ð¾Ñ€ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¸
  socket.on('confirm-profession', async (data) => {
    try {
      console.log('âœ… ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¸ Ð¾Ñ‚:', socket.id, data);
      
      const result = await roomController.confirmProfession(data);
      if (result.success) {
        const room = await roomController.getRoom(data.roomId);
        if (room) {
          socket.emit('profession-confirmed', {
            roomId: data.roomId,
            playerId: data.playerId,
            profession: data.profession,
            confirmed: data.confirmed
          });
          io.to(data.roomId).emit('room-updated', roomController.getRoomClientData(room));
        }
      } else {
        socket.emit('error', { message: result.error || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¸' });
      }
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¸:', error);
      socket.emit('error', { message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¸' });
    }
  });

  // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¸
  socket.on('get-available-professions', async (data) => {
    try {
      console.log('ðŸŽ¯ Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¹ Ð¾Ñ‚:', socket.id, data);
      
      const result = await roomController.getAvailableProfessions(data.roomId);
      if (result.success) {
        socket.emit('available-professions', {
          roomId: data.roomId,
          professions: result.professions,
          selectionMode: 'choice',
          selectedProfessions: result.selectedProfessions
        });
      } else {
        socket.emit('error', { message: result.error || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¹' });
      }
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¹:', error);
      socket.emit('error', { message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¹' });
    }
  });

  // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð¼Ð½Ð°Ñ‚
  socket.on('rooms-updated', async () => {
    try {
      console.log('ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð½Ð°Ñ‚ Ð¾Ñ‚:', socket.id);
      const rooms = await roomController.getAllRooms();
      const roomsData = roomController.getRoomsListData(rooms);
      socket.emit('rooms-list', roomsData);
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð½Ð°Ñ‚:', error);
      socket.emit('error', { message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð½Ð°Ñ‚' });
    }
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
  socket.on('disconnect', async () => {
    console.log('ðŸ”Œ ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ:', socket.id);
    
    try {
      // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹, Ð³Ð´Ðµ Ð±Ñ‹Ð» ÑÑ‚Ð¾Ñ‚ Ð¸Ð³Ñ€Ð¾Ðº
      const rooms = await roomController.getAllRooms();
      for (const room of rooms) {
        const player = room.players.get(socket.id);
        if (player) {
          const result = await roomController.leaveRoom(room.id, socket.id);
          if (result.success && result.room) {
            io.to(room.id).emit('room-updated', roomController.getRoomClientData(result.room));
            io.emit('rooms-updated');
            console.log('ðŸ‘‹ Ð˜Ð³Ñ€Ð¾Ðº Ð¿Ð¾ÐºÐ¸Ð½ÑƒÐ» ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñƒ:', room.id);
          }
          break;
        }
      }
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸ Ð¸Ð³Ñ€Ð¾ÐºÐ°:', error);
    }
  });
});

// ===== Ð¡Ð•Ð Ð’Ð•Ð  STARTUP =====

const PORT = process.env.PORT || 4000;
const HOST = process.env.NODE_ENV === 'production' ? '0.0.0.0' : 'localhost';

server.listen(PORT, HOST, async () => {
  console.log(`ðŸš€ Rooms Server Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° ${HOST}:${PORT}`);
  console.log(`ðŸŒ Environment: ${process.env.NODE_ENV || 'development'}`);
  console.log(`ðŸ”— Front origin: ${FRONT_ORIGIN}`);
  
  // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
  try {
    await DatabaseService.connect();
    console.log('âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°');
    
    // Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚
    const rooms = await roomController.getAllRooms();
    console.log(`ðŸ”„ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ ${rooms.length} Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… ÐºÐ¾Ð¼Ð½Ð°Ñ‚`);
    
    console.log('âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½');
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°:', error);
  }
});

server.on('error', (err) => {
  console.error('âŒ Server error:', err);
});

// Graceful shutdown
process.on('SIGTERM', async () => {
  console.log('ðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ SIGTERM, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹...');
  await DatabaseService.disconnect();
  process.exit(0);
});

process.on('SIGINT', async () => {
  console.log('ðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ SIGINT, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹...');
  await DatabaseService.disconnect();
  process.exit(0);
});
