const express = require('express');
const cors = require('cors');
const { Server } = require('socket.io');
const { createServer } = require('http');
const { Telegraf } = require('telegraf');

const app = express();
const server = createServer(app);
const io = new Server(server, {
  cors: {
    origin: ["https://money8888-production.up.railway.app"],
    methods: ["GET", "POST"],
    credentials: true
  }
});

const PORT = process.env.PORT || 4000;
const HOST = process.env.NODE_ENV === 'production' ? '0.0.0.0' : 'localhost';

// Telegram Bot
const BOT_TOKEN = process.env.BOT_TOKEN || '8480976603:AAEcYvQ51AEQqeVtaJDypGfg_xMcO7ar2rI';
const bot = new Telegraf(BOT_TOKEN);

// Middleware
app.use(cors({
  origin: ["https://money8888-production.up.railway.app"],
  credentials: true
}));
app.use(express.json());

// –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –∫–æ–º–Ω–∞—Ç
const tokens = new Map(); // token -> { userId, username, createdAt }
const rooms = new Map(); // roomId -> room data

// ===== EXPRESS ENDPOINTS =====

app.get('/', (req, res) => {
  res.json({ 
    ok: true, 
    message: 'Energy888 Unified Server is running',
    environment: process.env.NODE_ENV || 'development',
    port: PORT,
    host: HOST,
    timestamp: new Date().toISOString(),
    endpoints: {
      health: '/health',
      newToken: '/tg/new-token',
      poll: '/tg/poll',
      authorize: '/tg/authorize'
    }
  });
});

app.get('/health', (req, res) => {
  res.json({ 
    ok: true, 
    status: 'healthy',
    uptime: process.uptime(),
    memory: process.memoryUsage(),
    tokens: tokens.size,
    rooms: rooms.size
  });
});

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
app.get('/tg/new-token', (req, res) => {
  try {
    const token = `t_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω (–±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–∫–∞)
    tokens.set(token, {
      createdAt: Date.now(),
      authorized: false
    });
    
    console.log('üîë –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω:', token);
    
    res.json({ 
      ok: true, 
      token,
      expiresIn: 300000 // 5 –º–∏–Ω—É—Ç
    });
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);
    res.status(500).json({ ok: false, error: 'Failed to create token' });
  }
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç–æ–∫–µ–Ω–∞
app.get('/tg/poll', (req, res) => {
  try {
    const { token } = req.query;
    
    if (!token) {
      return res.status(400).json({ ok: false, error: 'Token required' });
    }
    
    const tokenData = tokens.get(token);
    
    if (!tokenData) {
      return res.status(404).json({ ok: false, error: 'Token not found' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫ –ª–∏ —Ç–æ–∫–µ–Ω (5 –º–∏–Ω—É—Ç)
    if (Date.now() - tokenData.createdAt > 300000) {
      tokens.delete(token);
      return res.status(410).json({ ok: false, error: 'Token expired' });
    }
    
    res.json({
      ok: true,
      authorized: tokenData.authorized,
      user: tokenData.user || null
    });
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:', error);
    res.status(500).json({ ok: false, error: 'Failed to check token' });
  }
});

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
app.post('/tg/authorize', async (req, res) => {
  try {
    const { token, id, username, first_name, last_name, photo_url } = req.body;
    
    console.log('üîê –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', { token, id, username });
    
    if (!token) {
      return res.status(400).json({ ok: false, error: 'Token required' });
    }
    
    const tokenData = tokens.get(token);
    
    if (!tokenData) {
      return res.status(404).json({ ok: false, error: 'Token not found' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫ –ª–∏ —Ç–æ–∫–µ–Ω
    if (Date.now() - tokenData.createdAt > 300000) {
      tokens.delete(token);
      return res.status(410).json({ ok: false, error: 'Token expired' });
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userData = {
      id: `tg_${id}`,
      username: username || `user_${id}`,
      tgId: id,
      firstName: first_name,
      lastName: last_name,
      photoUrl: photo_url
    };
    
    tokenData.authorized = true;
    tokenData.user = userData;
    
    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', userData);
    
    res.json({ 
      ok: true, 
      authorized: true,
      user: userData
    });
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
    res.status(500).json({ ok: false, error: 'Authorization failed' });
  }
});

// ===== SOCKET.IO EVENTS =====

io.on('connection', (socket) => {
  console.log('üîå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è:', socket.id);
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
  socket.on('getRooms', () => {
    const roomsList = Array.from(rooms.values());
    console.log('üìã –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç:', roomsList.length);
    socket.emit('roomsList', roomsList);
  });
  
  // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
  socket.on('createRoom', (roomData) => {
    try {
      const roomId = `room_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
      
      const newRoom = {
        id: roomId,
        name: roomData.name || `–ö–æ–º–Ω–∞—Ç–∞ ${roomData.creatorUsername}`,
        creatorId: roomData.creatorId,
        creatorUsername: roomData.creatorUsername,
        creatorProfession: roomData.creatorProfession,
        creatorDream: roomData.creatorDream,
        assignProfessionToAll: roomData.assignProfessionToAll,
        maxPlayers: roomData.maxPlayers,
        password: roomData.password,
        timing: roomData.timing,
        gameDurationSec: roomData.gameDurationSec,
        hasPassword: !!roomData.password,
        players: [{
          id: roomData.creatorId,
          username: roomData.creatorUsername,
          profession: roomData.creatorProfession,
          dream: roomData.creatorDream
        }],
        status: 'waiting',
        createdAt: new Date().toISOString()
      };
      
      rooms.set(roomId, newRoom);
      
      console.log('üè† –°–æ–∑–¥–∞–Ω–∞ –∫–æ–º–Ω–∞—Ç–∞:', newRoom.name, 'ID:', roomId);
      
      // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –æ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç–µ
      io.emit('roomsList', Array.from(rooms.values()));
      
      socket.emit('roomCreated', { ok: true, roomId });
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã:', error);
      socket.emit('roomCreated', { ok: false, error: 'Failed to create room' });
    }
  });
  
  // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
  socket.on('joinRoomMeta', (data) => {
    try {
      const { roomId, user, password } = data;
      const room = rooms.get(roomId);
      
      if (!room) {
        socket.emit('joinRoomResult', { ok: false, error: 'Room not found' });
        return;
      }
      
      if (room.hasPassword && room.password !== password) {
        socket.emit('joinRoomResult', { ok: false, error: 'Invalid password' });
        return;
      }
      
      if (room.players.length >= room.maxPlayers) {
        socket.emit('joinRoomResult', { ok: false, error: 'Room is full' });
        return;
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ –≤ –∫–æ–º–Ω–∞—Ç—É
      room.players.push({
        id: user.id,
        username: user.username,
        profession: room.creatorProfession, // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏—é —Å–æ–∑–¥–∞—Ç–µ–ª—è
        dream: room.creatorDream
      });
      
      console.log('üë§ –ò–≥—Ä–æ–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ:', user.username, '–ö–æ–º–Ω–∞—Ç–∞:', room.name);
      
      // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
      io.emit('roomsList', Array.from(rooms.values()));
      
      socket.emit('joinRoomResult', { ok: true, room });
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ:', error);
      socket.emit('joinRoomResult', { ok: false, error: 'Failed to join room' });
    }
  });
  
  socket.on('disconnect', () => {
    console.log('üîå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è:', socket.id);
  });
});

// ===== TELEGRAM BOT =====

bot.start((ctx) => {
  const message = ctx.message.text;
  const token = message.split(' ')[1]; // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –∫–æ–º–∞–Ω–¥—ã /start login_token
  
  if (token && token.startsWith('login_')) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const loginToken = token.replace('login_', '');
    handleLogin(ctx, loginToken);
  } else {
    ctx.reply('üéÆ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É "–≠–Ω–µ—Ä–≥–∏—è –î–µ–Ω–µ–≥"!\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.');
  }
});

// –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
async function handleLogin(ctx, token) {
  try {
    const user = ctx.from;
    
    console.log('üîê –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞:', { token, userId: user.id, username: user.username });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –Ω–∞—à —Å–µ—Ä–≤–µ—Ä
    const serverUrl = process.env.NODE_ENV === 'production' 
      ? 'https://money8888-production.up.railway.app'
      : `http://localhost:${PORT}`;
    
    const response = await fetch(`${serverUrl}/tg/authorize`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        token,
        id: user.id,
        username: user.username,
        first_name: user.first_name,
        last_name: user.last_name,
        photo_url: user.photo_url
      })
    });
    
    const result = await response.json();
    
    if (result.ok && result.authorized) {
      await ctx.reply('‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª–∏—Å—å!\n\nüéÆ –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏–≥—Ä–∞—Ç—å –≤ Energy of Money!\n\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–≥—Ä—ã.');
    } else {
      await ctx.reply('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞. –í–æ–∑–º–æ–∂–Ω–æ, —Å—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞:', error);
    await ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
}

bot.command('help', (ctx) => {
  ctx.reply(`
üéÆ –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:

/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É

üåê –ò–≥—Ä–∞: https://money8888-production.up.railway.app
  `);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–æ—Ç–∞
bot.catch((err, ctx) => {
  console.error('‚ùå –û—à–∏–±–∫–∞ –±–æ—Ç–∞:', err);
  ctx.reply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
});

// ===== –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê =====

// –ó–∞–ø—É—Å–∫ Express + Socket.IO —Å–µ—Ä–≤–µ—Ä–∞
server.listen(PORT, HOST, () => {
  console.log(`üöÄ Unified Server listening on ${HOST}:${PORT}`);
  console.log(`üåê Environment: ${process.env.NODE_ENV || 'development'}`);
  console.log(`üì± Process ID: ${process.pid}`);
  console.log(`üîå Socket.IO enabled`);
});

// –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞
bot.launch()
  .then(() => {
    console.log('ü§ñ Telegram Bot started successfully!');
    console.log(`üì± Bot token: ${BOT_TOKEN.substring(0, 10)}...`);
  })
  .catch((err) => {
    console.error('‚ùå Bot failed to start:', err);
  });

// Graceful shutdown
process.once('SIGINT', () => {
  console.log('üõë Shutting down server...');
  bot.stop('SIGINT');
  server.close(() => {
    process.exit(0);
  });
});

process.once('SIGTERM', () => {
  console.log('üõë Shutting down server...');
  bot.stop('SIGTERM');
  server.close(() => {
    process.exit(0);
  });
});

module.exports = { app, server, io, bot };
